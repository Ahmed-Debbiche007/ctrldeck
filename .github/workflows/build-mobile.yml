name: Build Mobile APK

on:
  workflow_dispatch:
  workflow_call:

jobs:
  deploy-pwa:
    name: Deploy PWA to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile-client/package-lock.json

      - name: Install dependencies
        working-directory: mobile-client
        run: npm ci

      - name: Build PWA
        working-directory: mobile-client
        run: npm run build

      - name: Install ImageMagick for icon generation
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate PNG icons from SVG
        working-directory: mobile-client
        run: |
          mkdir -p dist/icons
          for size in 72 96 128 144 152 192 384 512; do
            convert -background none -resize ${size}x${size} public/icons/icon.svg dist/icons/icon-${size}x${size}.png
          done
          cp public/icons/icon.svg dist/icons/

      - name: Prepare Pages directory structure
        run: |
          mkdir -p _site/mobile
          cp -r mobile-client/dist/* _site/mobile/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  build-android:
    name: Build Android APK (Bubblewrap TWA - Unsigned)
    runs-on: ubuntu-latest
    needs: deploy-pwa

    env:
      ANDROID_HOME: /usr/local/lib/android/sdk
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: 11076708
          packages: 'platform-tools platforms;android-35 build-tools;35.0.0'

      - name: Accept Android licenses
        run: yes | sdkmanager --licenses || true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      - name: Wait for GitHub Pages deployment
        run: |
          echo "Waiting for GitHub Pages to be available..."
          sleep 30
          for i in {1..10}; do
            if curl -s -o /dev/null -w "%{http_code}" "https://ahmed-debbiche007.github.io/streamdeck/mobile/" | grep -q "200"; then
              echo "GitHub Pages is available!"
              break
            fi
            echo "Attempt $i: GitHub Pages not ready yet, waiting..."
            sleep 10
          done

      - name: Create working directory
        run: mkdir -p twa-build

      - name: Generate debug keystore
        working-directory: twa-build
        run: |
          keytool -genkeypair \
            -alias android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore android.keystore \
            -storepass android \
            -keypass android \
            -dname "CN=Debug, OU=Debug, O=Debug, L=Unknown, ST=Unknown, C=US"

      - name: Initialize Bubblewrap project
        working-directory: twa-build
        run: |
          echo "Initializing Bubblewrap with manifest..."
          bubblewrap init --manifest="https://ahmed-debbiche007.github.io/streamdeck/mobile/manifest.json" --directory=. << EOF
          y
          android
          android
          EOF
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: Build unsigned APK
        working-directory: twa-build
        run: |
          bubblewrap build --skipPwaValidation --skipSigning << EOF
          android
          android
          EOF
        env:
          JAVA_HOME: ${{ env.JAVA_HOME }}

      - name: List build outputs
        working-directory: twa-build
        run: |
          echo "Build outputs:"
          ls -la
          find . -name "*.apk" -o -name "*.aab" 2>/dev/null || echo "No APK/AAB files found"

      - name: Upload unsigned APK
        uses: actions/upload-artifact@v4
        with:
          name: streamdeck-android-unsigned
          path: |
            twa-build/*.apk
            twa-build/app-release-unsigned.apk
            twa-build/app/build/outputs/apk/**/*.apk
          if-no-files-found: warn
